{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faktury - CNC Tools</title>
    <link rel="icon" href="{% static 'images/cnc-logo.png' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <style>
        body { background-color: #f8f9fa; }
        .card-body { background-color: white; }
        .pagination { justify-content: center; }
        .page-item.disabled .page-link { color: #6c757d; }
        .page-item.active .page-link { z-index: 1; color: #fff; background-color: #0d6efd; border-color: #0d6efd;}
         /* Styl dla wymaganej etykiety */
        .required-label::after { content: " *"; color: red; }
         /* Styl dla spinnera */
        .spinner-button { display: inline-block; width: 1rem; height: 1rem; vertical-align: text-bottom; border: .2em solid currentColor; border-right-color: transparent; border-radius: 50%; -webkit-animation: .75s linear infinite spinner-border; animation: .75s linear infinite spinner-border; } @keyframes spinner-border { to { transform: rotate(360deg); } }

        .required-label::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="d-flex justify-content-between align-items-center p-3 px-4 text-light border-bottom border-secondary" style="background: linear-gradient(to bottom, #495057, #212529);">
            <h2 class="mb-0"><strong>CNC MILLING: <span style="color: yellow;">Faktury</span></strong></h2>
            <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                <a href="{% url 'ustawienia' %}?next={% url 'faktury' %}" class="btn btn-secondary shadow-sm" title="Ustawienia" style="margin-right: 5px;"><i class="fa-solid fa-gear"></i> Ustawienia</a>
                <a href="{% url 'zamowienia' %}" class="btn btn-success shadow-sm" title="Zamówienia" style="margin-right: 5px;"><i class="fa-solid fa-file-invoice"></i> Zamówienia</a>
                <a href="{% url 'magazyn' %}" class="btn btn-light shadow-sm" title="Przełącz na panel Magazyniera" style="margin-left: 5px;"><i class="fa-solid fa-warehouse"></i> Magazyn</a>
                <a href="{% url 'zakupy' %}" class="btn btn-light shadow-sm" title="Przełącz na panel Zakupy" style="margin-left: 5px;"><i class="fa-solid fa-truck"></i> Zakupy</a>
                <a href="{% url 'logout' %}" class="btn btn-danger shadow-sm" title="Wyloguj" style="margin-left: 5px;"><i class="fa-solid fa-right-from-bracket"></i> Wyjście</a>
            </div>
        </div>

        <main class="container mt-4">
             <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Zarządzaj Fakturami</h3>
                    <button class="btn btn-primary" @click="openModal('add')"><i class="fa-solid fa-plus me-2"></i>Dodaj nową</button>
                </div>
                <div class="card-body">
                    <div v-if="isLoading" class="text-center"> <div class="spinner-border" role="status"></div> </div>
                    <div v-else>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Numer faktury</th>
                                    <th>Data wystawienia</th>
                                    <th>Dostawca</th>
                                    <th>Rozliczona</th>
                                    <th class="text-center">Plik</th>
                                    <th class="text-end">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="!faktury.length">
                                    <td colspan="6" class="text-center text-muted">Brak faktur.</td>
                                </tr>
                                <tr v-for="item in faktury" :key="item.id">
                                    <td>[[ item.numer_faktury ]]</td>
                                    <td>[[ item.data_wystawienia ]]</td>
                                    <td>[[ item.dostawca.nazwa_firmy ]]</td>
                                    <td>
                                        <i v-if="item.rozliczone" class="fas fa-check-circle text-success"></i>
                                        <i v-else class="fas fa-times-circle text-danger"></i>
                                    </td>
                                    <td class="text-center">
                                        <a v-if="item.plik" :href="item.plik" target="_blank" class="btn btn-sm btn-outline-primary" title="Otwórz plik">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                        <span v-else class="text-muted">-</span>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-secondary" @click="openModal('edit', item)"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="btn btn-sm btn-danger ms-1" @click="showDeleteModal(item.id)"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <nav v-if="pagination.totalPages > 1" aria-label="Nawigacja po stronach">
                            <ul class="pagination mt-3">
                                <li class="page-item" :class="{ disabled: !pagination.previous }">
                                    <a class="page-link" href="#" @click.prevent="fetchFaktury(pagination.previous)">&laquo; Poprzednia</a>
                                </li>
                                <li class="page-item" v-for="page in pagination.pageNumbers" :key="page" :class="{ active: page === pagination.currentPage }">
                                    <a class="page-link" href="#" @click.prevent="fetchFaktury(getPageUrl(page))">[[ page ]]</a>
                                </li>
                                <li class="page-item" :class="{ disabled: !pagination.next }">
                                    <a class="page-link" href="#" @click.prevent="fetchFaktury(pagination.next)">Następna &raquo;</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>

        <div class="modal fade" tabindex="-1" ref="itemModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">[[ modal.title ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="modal.errorMessage" class="alert alert-danger" role="alert">
                            <strong>Błąd:</strong> [[ modal.errorMessage ]]
                        </div>

                         <div class="mb-3">
                            <label class="form-label required-label">Numer faktury</label>
                            <input type="text" class="form-control" v-model="modal.currentItem.numer_faktury">
                        </div>
                         <div class="mb-3">
                            <label class="form-label required-label">Data wystawienia</label>
                            <input type="date" class="form-control" v-model="modal.currentItem.data_wystawienia">
                        </div>
                        <div class="mb-3">
                            <label class="form-label required-label">Dostawca</label>
                            <select class="form-select" v-model="modal.currentItem.dostawca_id">
                                <option :value="null">-- Wybierz dostawcę --</option>
                                <option v-for="dostawca in dostawcy" :key="dostawca.id" :value="dostawca.id">
                                    [[ dostawca.nazwa_firmy ]] ([[ dostawca.kod_dostawcy ]])
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="invoiceFile" class="form-label">Plik faktury (PDF, obraz)</label>
                            <input class="form-control" type="file" id="invoiceFile" @change="handleFileUpload" accept=".pdf,image/*">
                            <small v-if="modal.mode === 'edit' && modal.currentItem.plik" class="d-block mt-1">
                                Obecny plik: <a :href="modal.currentItem.plik" target="_blank">[[ modal.currentItem.plik.split('/').pop() ]]</a>. Wybierz nowy, aby zastąpić.
                            </small>
                        </div>
                         <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="rozliczoneCheck" v-model="modal.currentItem.rozliczone">
                            <label class="form-check-label" for="rozliczoneCheck">
                                Faktura rozliczona
                            </label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" :disabled="isSaving">Anuluj</button>
                        <button v-if="!isSaving" type="button" class="btn btn-primary" @click="saveItem">Zapisz</button>
                         <button v-else class="btn btn-primary" type="button" disabled>
                            <span class="spinner-button" role="status" aria-hidden="true"></span>
                            Zapisywanie...
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" tabindex="-1" ref="deleteModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Potwierdź usunięcie</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Czy na pewno chcesz trwale usunąć tę fakturę?</p>
                        <p class="text-danger">Tej operacji nie można cofnąć.</p>
                         <p class="text-warning">Upewnij się, że żadne egzemplarze narzędzi nie są powiązane z tą fakturą przed usunięciem.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="button" class="btn btn-danger" @click="confirmDeleteItem">Tak, usuń</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <script src="{% static 'js/main_faktury.js' %}"></script>
</body>
</html>


